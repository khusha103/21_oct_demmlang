<ion-header>
  <ion-toolbar color="primary">
    <ion-title>
      <ion-icon name="language-outline"></ion-icon>
      Chat Translator
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="showLanguageSelector = !showLanguageSelector" title="Language Settings">
        <ion-icon slot="icon-only" name="settings-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

 

  <!-- Compact Language Settings Panel -->
  <ion-toolbar *ngIf="showLanguageSelector" color="light" [@fadeIn] class="compact-settings">
    <div class="settings-row">
      <div class="lang-setting">
        <ion-label>My Language</ion-label>
        <ion-select [(ngModel)]="appLanguage" interface="popover" placeholder="Select">
          <ion-select-option *ngFor="let lang of languageNames | keyvalue" [value]="lang.key">
            {{ lang.value }}
          </ion-select-option>
        </ion-select>
      </div>
      <div class="lang-setting">
        <ion-label>Receiver</ion-label>
        <ion-select [(ngModel)]="receiverLanguage" (ionChange)="setReceiverLanguage($event.detail.value)"
          interface="popover" placeholder="Select">
          <ion-select-option *ngFor="let lang of languageNames | keyvalue" [value]="lang.key">
            {{ lang.value }}
          </ion-select-option>
        </ion-select>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content #content class="ion-padding">

  <!-- Privacy Consent Banner -->
  <ion-card *ngIf="showConsentBanner" class="consent-banner" [@fadeIn]>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="shield-checkmark-outline"></ion-icon>
        Translation Privacy Notice
      </ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <p>We use Google Translate to help you communicate across languages.</p>

      <div class="consent-points">
        <div class="point">
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
          <span>Messages sent securely via HTTPS</span>
        </div>
        <div class="point">
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
          <span>No personal info shared</span>
        </div>
        <div class="point">
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
          <span>You control your data</span>
        </div>
      </div>

      <div class="consent-actions">
        <ion-button size="small" fill="clear" (click)="openPrivacyPolicy()">
          Learn More
        </ion-button>
        <ion-button size="small" fill="outline" (click)="declineConsent()">
          Not Now
        </ion-button>
        <ion-button size="small" color="primary" (click)="grantConsent()">
          I Understand
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Chat Messages - Compact View -->
  <div *ngFor="let msg of messages; let i = index" [@slideIn] class="msg-wrap">
    <div class="chat-bubble" [ngClass]="{ 'from-user': msg.from === 'user', 'from-bot': msg.from !== 'user' }">

      <!-- Message Text -->
      <p class="msg-txt">{{ msg.languages[msg.currentLangIndex]?.text }}</p>

      <!-- Compact Meta Row -->
      <div class="meta-row">
        <div class="left-meta">
          <ion-badge *ngIf="msg.languages.length > 1" color="medium" class="lang-tag">
            {{ msg.languages[msg.currentLangIndex]?.label }}
          </ion-badge>
          <span class="time">{{ msg.timestamp | date:'shortTime' }}</span>
        </div>

        <!-- Compact Actions -->
        <div class="actions">

          <ion-button size="small" fill="clear" (click)="copyMessageText(msg)" title="Copy">
            <ion-icon slot="icon-only" name="copy-outline"></ion-icon>
          </ion-button>


          <ion-button *ngIf="msg.languages.length > 1" size="small" fill="clear" color="medium"
            (click)="toggleLanguage(i)" title="Switch language" class="toggle-lang-btn">
            <ion-icon slot="start" name="swap-horizontal-outline"></ion-icon>
            <ion-label>{{ msg.languages[msg.currentLangIndex]?.label }}</ion-label>
          </ion-button>

        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="messages.length === 0" class="empty-state">
    <ion-icon name="chatbubbles-outline" color="medium"></ion-icon>
    <p>Start chatting in any language</p>
  </div>

</ion-content>

<!-- Compact Footer -->
<ion-footer>
  <ion-toolbar class="compact-footer">

  <!-- Compact Read-Only Preview -->
<div *ngIf="previewActive" class="preview-card" [@fadeIn]>
  <div class="preview-header">
    <div class="preview-title">
      <ion-icon name="sparkles"></ion-icon>
      <span>Translation Ready</span>
    </div>
    <ion-button size="small" fill="clear" (click)="clearPreviewAndTranslation()" class="close-preview">
      <ion-icon slot="icon-only" name="close-circle"></ion-icon>
    </ion-button>
  </div>

  <!-- Translation Display -->
  <div class="translation-display">
    <div class="lang-badge">{{ translatedLanguage }}</div>
    <p class="translated-text">{{ translatedPreview }}</p>
  </div>

  <!-- Original Reference (collapsible) -->
  <div class="original-reference">
    <ion-icon name="document-text-outline"></ion-icon>
    <span class="original-text">{{ originalEnglishMessage }}</span>
  </div>

  <!-- Action Buttons - Compact & Clear -->
  <div class="preview-actions">
    <ion-button 
      expand="block" 
      color="primary" 
      shape="round"
      (click)="sendTranslatedMessage()" 
      class="send-translation-btn">
      <ion-icon name="send" slot="start"></ion-icon>
      Send Translation
    </ion-button>
    <ion-button 
      fill="clear" 
      color="medium" 
      size="small"
      (click)="clearPreviewAndTranslation()"
      class="cancel-btn">
      Cancel
    </ion-button>
  </div>
</div>

    <!-- Compact Message Input -->
    <div class="input-bar">
      <ion-textarea [autoGrow]="true" [(ngModel)]="typedMessage" placeholder="Type message..." class="msg-input"
        (keyup.enter)="quickTranslateMode ? translateToReceiver() : sendOriginalMessage()" [rows]="1"></ion-textarea>

      <ion-button *ngIf="!previewActive" fill="clear" color="primary" (click)="sendOriginalMessage()"
        [disabled]="!typedMessage.trim()" class="send-btn">
        <ion-icon slot="icon-only" name="send"></ion-icon>
      </ion-button>
    </div>

    <div *ngIf="!previewActive && typedMessage.trim()" class="trans-btns-inline fade-in">
      <ion-row class="ion-align-items-center ion-justify-content-center">
        <!-- ðŸ”µ Receiver Translation -->
        <ion-col size="6" class="btn-wrapper">
          <ion-button size="small" expand="block" fill="solid" color="primary" shape="round"
            (click)="translateToReceiver()" [disabled]="isTranslating"
            title="Translate your message to receiver's language before sending">
            <ion-icon name="send-outline" slot="start"></ion-icon>
            <span *ngIf="!isTranslating">To {{ languageNames[receiverLanguage] || receiverLanguage | uppercase }}</span>
            <ion-spinner *ngIf="isTranslating" name="crescent"></ion-spinner>
          </ion-button>
          <small class="btn-label">Receiver Translation</small>
        </ion-col>

        <!-- ðŸŸ¢ Sender Translation -->
        <ion-col size="6" class="btn-wrapper">
          <ion-button size="small" expand="block" fill="outline" color="success" shape="round"
            (click)="translateToMyLanguage()" [disabled]="isTranslating"
            title="Translate to your app language for reference">
            <ion-icon name="globe-outline" slot="start"></ion-icon>
            <span>To {{ languageNames[appLanguage] || appLanguage | uppercase }}</span>
          </ion-button>
          <small class="btn-label">My Language</small>
        </ion-col>

        <!-- ðŸ—‘ï¸ Clear button -->
        <ion-col size="auto" class="trash-col">
          <ion-button size="small" fill="clear" color="medium" (click)="clearAllMessages()" title="Clear all messages">
            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
          </ion-button>
        </ion-col>
      </ion-row>
    </div>


  </ion-toolbar>
</ion-footer>